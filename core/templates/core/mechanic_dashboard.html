{% extends 'base.html' %}
{% block title %}THE_SERV_1 | Mechanic Dashboard{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto py-8">
  <div class="bg-gradient-to-br from-indigo-900 to-indigo-700 rounded-2xl shadow-lg p-8 border border-indigo-800 mb-8 flex items-center gap-6 animate-card transition duration-500 hover:scale-105 hover:shadow-2xl">
    <div class="text-5xl text-yellow-300">üõ†Ô∏è</div>
    <div>
  <h2 class="text-3xl font-bold text-white mb-2">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ä‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏° | THE_SERV_1</h2>
      <p class="text-indigo-100">‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-xl p-6 border border-indigo-200 animate-fadein transition duration-500 hover:scale-105 hover:shadow-2xl">
    <h3 class="text-xl font-bold text-indigo-900 mb-4 flex items-center gap-2">ÔøΩ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
    <div class="overflow-x-auto">
  <table class="w-full border text-sm animate-fadein">
        <thead class="bg-indigo-100">
          <tr>
            <th class="border px-2 py-1">ID</th>
            <th class="border px-2 py-1">User</th>
            <th class="border px-2 py-1">Bike</th>
            <th class="border px-2 py-1">Details</th>
            <th class="border px-2 py-1">Service</th>
            <th class="border px-2 py-1">Date</th>
            <th class="border px-2 py-1">Time</th>
            <th class="border px-2 py-1">Status</th>
            <th class="border px-2 py-1">Pickup Date</th>
            <th class="border px-2 py-1">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for bk in bookings %}
          <tr class="hover:bg-indigo-100 transition duration-300 hover:scale-105 animate-list">
            <td class="border px-2 py-1 align-top">{{ bk.id }}</td>
            <td class="border px-2 py-1 align-top">{{ bk.user.username }}</td>
            <td class="border px-2 py-1 align-top">
              <div class="font-semibold text-indigo-900">{{ bk.bike.brand }} {{ bk.bike.model }}</div>
              <div class="text-xs text-gray-500">‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: {{ bk.bike.plate_number|default:'-' }}</div>
              <div class="text-xs text-gray-500">‡∏õ‡∏µ: {{ bk.bike.year|default:'-' }}</div>
            </td>
            <td class="border px-2 py-1 align-top">
              <div class="text-xs text-gray-700">‡∏à‡∏≠‡∏á‡πÇ‡∏î‡∏¢: <span class="font-semibold">{{ bk.user.get_full_name|default:bk.user.username }}</span></div>
              <div class="text-xs text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå: <span class="font-semibold">{{ bk.user.mechanic_profile.phone|default:'-' }}</span></div>
              <div class="text-xs text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <span class="font-normal">{{ bk.notes|default:'-' }}</span></div>
              <div class="text-xs text-gray-700">‡∏£‡∏≤‡∏Ñ‡∏≤: <span class="font-semibold">{{ bk.price|default:'-' }}</span></div>
            </td>
            <td class="border px-2 py-1 align-top">{{ bk.service_type }}</td>
            <td class="border px-2 py-1 align-top">{{ bk.booking_date }}</td>
            <td class="border px-2 py-1 align-top">{{ bk.booking_time }}</td>
            <td class="border px-2 py-1 align-top">
                <td class="px-4 py-2">
                    <form method="post" action="{% url 'mechanic_update_status' bk.id %}" class="inline status-form">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="/mechanic/dashboard/">
                      <div class="relative inline-block w-36">
                        <select name="status" class="block w-full px-3 py-1 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition text-xs font-semibold
                          {% if bk.status == 'done' %}bg-green-100 text-green-700{% elif bk.status == 'pending' %}bg-gray-200 text-gray-600{% elif bk.status == 'in_progress' %}bg-yellow-100 text-yellow-700{% elif bk.status == 'cancelled' %}bg-red-100 text-red-700{% endif %}"
                          onchange="this.form.submit()">
                          <option value="pending" {% if bk.status == 'pending' %}selected{% endif %}>Pending</option>
                          <option value="in_progress" {% if bk.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                          <option value="done" {% if bk.status == 'done' %}selected{% endif %}>Done</option>
                          <option value="cancelled" {% if bk.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                      </div>
                    </form>
                  </td>
            </td>
            <td class="border px-2 py-1 align-top">{% if bk.pickup_date %}{{ bk.pickup_date }}{% else %}-{% endif %}</td>
            <td class="border px-2 py-1 align-top">
              {% if bk.status == 'pending' %}
                <span class="inline-block px-3 py-1 bg-gray-300 text-gray-700 rounded-full text-xs font-bold shadow">Pending</span>
              {% elif bk.status == 'confirmed' %}
                <form method="post" action="{% url 'mechanic_update_status' bk.id %}" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="in_progress">
                  <button class="px-3 py-1 bg-yellow-400 text-white rounded-full hover:bg-yellow-500 transition text-xs font-bold shadow"><span class="mr-1">üîß</span>In Progress</button>
                </form>
                <form method="post" action="{% url 'mechanic_update_status' bk.id %}" style="display:inline; margin-left:4px;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="cancelled">
                  <button class="px-3 py-1 bg-red-400 text-white rounded-full hover:bg-red-500 transition text-xs font-bold shadow"><span class="mr-1">‚úñÔ∏è</span>Cancel</button>
                </form>
              {% elif bk.status == 'in_progress' %}
                <button type="button" onclick="openDoneModal({{ bk.id }})" class="px-3 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-700 transition text-xs font-bold shadow"><span class="mr-1">‚úÖ</span>Done</button>
                <form method="post" action="{% url 'mechanic_update_status' bk.id %}" style="display:inline; margin-left:4px;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="cancelled">
                  <button class="px-3 py-1 bg-red-400 text-white rounded-full hover:bg-red-500 transition text-xs font-bold shadow"><span class="mr-1">‚úñÔ∏è</span>Cancel</button>
                </form>
              {% elif bk.status == 'done' %}
                <span class="inline-block px-3 py-1 bg-green-400 text-white rounded-full text-xs font-bold shadow"><span class="mr-1">‚úîÔ∏è</span>Done</span>
              {% elif bk.status == 'cancelled' %}
                <span class="inline-block px-3 py-1 bg-red-400 text-white rounded-full text-xs font-bold shadow"><span class="mr-1">‚úñÔ∏è</span>Cancelled</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal for marking as done (pickup date) -->
  <div id="doneModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden animate-fadein">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md transition duration-500 hover:scale-105 hover:shadow-2xl">
      <h3 class="text-lg font-bold mb-4">‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏ñ</h3>
      <form id="doneForm" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="done">
        <input type="hidden" name="booking_id" id="modalBookingId">
        <label class="block mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏ñ</label>
        <input type="date" name="pickup_date" class="border rounded px-3 py-2 w-full mb-4" required>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeDoneModal()" class="px-4 py-2 bg-gray-200 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="px-4 py-2 bg-indigo-700 text-white rounded">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    function openDoneModal(bookingId) {
      document.getElementById('doneModal').style.display = 'flex';
      document.getElementById('modalBookingId').value = bookingId;
      document.getElementById('doneForm').action = '/mechanic/booking/' + bookingId + '/update/';
    }
    function closeDoneModal() {
      document.getElementById('doneModal').style.display = 'none';
    }
  </script>
{% endblock %}
