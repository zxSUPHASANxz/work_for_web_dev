{% extends 'base.html' %}
{% block title %}Mechanic Dashboard{% endblock %}
{% block content %}
<div class="max-w-5xl mx-auto">
  <h2 class="text-2xl font-bold mb-6 text-blue-900">üîß ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
  <div class="overflow-x-auto">
    <table class="w-full border text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-2 py-1">ID</th>
          <th class="border px-2 py-1">User</th>
          <th class="border px-2 py-1">Bike</th>
          <th class="border px-2 py-1">Service</th>
          <th class="border px-2 py-1">Date</th>
          <th class="border px-2 py-1">Time</th>
          <th class="border px-2 py-1">Status</th>
          <th class="border px-2 py-1">Pickup Date</th>
          <th class="border px-2 py-1">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for bk in bookings %}
        <tr>
          <td class="border px-2 py-1">{{ bk.id }}</td>
          <td class="border px-2 py-1">{{ bk.user.username }}</td>
          <td class="border px-2 py-1">{{ bk.bike.brand }} {{ bk.bike.model }}</td>
          <td class="border px-2 py-1">{{ bk.service_type }}</td>
          <td class="border px-2 py-1">{{ bk.booking_date }}</td>
          <td class="border px-2 py-1">{{ bk.booking_time }}</td>
          <td class="border px-2 py-1">
            <span class="font-semibold {% if bk.status == 'in_progress' %}text-yellow-600{% elif bk.status == 'done' %}text-green-700{% endif %}">{{ bk.get_status_display }}</span>
          </td>
          <td class="border px-2 py-1">
            {% if bk.pickup_date %}{{ bk.pickup_date }}{% else %}-{% endif %}
          </td>
          <td class="border px-2 py-1">
            {% if bk.status == 'confirmed' %}
              <form method="post" action="{% url 'mechanic_update_status' bk.id %}" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="in_progress">
                <button class="px-2 py-1 bg-yellow-400 text-white rounded hover:bg-yellow-500 transition text-xs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
              </form>
            {% elif bk.status == 'in_progress' %}
              <button onclick="openDoneModal({{ bk.id }})" class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition text-xs">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal for done status -->
<div id="doneModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
    <h3 class="text-lg font-bold mb-4">‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏ñ</h3>
    <form id="doneForm" method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="done">
      <input type="hidden" name="booking_id" id="modalBookingId">
      <label class="block mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏ñ</label>
      <input type="date" name="pickup_date" class="border rounded px-3 py-2 w-full mb-4" required>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeDoneModal()" class="px-4 py-2 bg-gray-200 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
    </form>
  </div>
</div>
<script>
  function openDoneModal(bookingId) {
    document.getElementById('doneModal').style.display = 'flex';
    document.getElementById('modalBookingId').value = bookingId;
    document.getElementById('doneForm').action = '/mechanic/booking/' + bookingId + '/update/';
  }
  function closeDoneModal() {
    document.getElementById('doneModal').style.display = 'none';
  }
</script>
{% endblock %}
